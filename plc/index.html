<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#222">
    <meta name="description" content="Entorno de desarrollo PlcNode">
    <meta name="author" content="JosÃ© Rosendo Soto Reza">
    <link rel="stylesheet" href="https://josereza.github.io/src/bootstrap.css">
    <title>PlcNode IDE</title>
    <meta name="theme-color" content="#F0DB4F">
    <meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="shortcut icon" type="image/png" href="https://josereza.github.io/proyects/plc_node/src/plc_node.png">
    <link rel="apple-touch-icon" href="https://josereza.github.io/proyects/plc_node/src/plc_node.png">
    <link rel="apple-touch-startup-image" href="https://josereza.github.io/proyects/plc_node/src/plc_node.png">
    <link rel="manifest" href="./manifest.json">
</head>
<body style="background-color: #ffffffde;">
    <div style="background-color: #000000de;" class="navbar">
        <button id="btn_save" style="background-color: #00aeffde; border-radius: 0.25%;" class="btn btn-warning">save</button>
    </div>
        <table style="width: 100%;">
            <thead style="background-color:#00aeffde; color: white;">
                <td style="padding: 1%;">Principal Programming</td>
                <td style="padding: 1%;">Debugger</td>
                <td style="padding: 1%;">Options</td>
            </thead>   
            <tbody>
                <td style="padding: 1%;">
                    <textarea id="plc_py" style="width: 100%; resize: none;" rows="18" spellcheck="false"> </textarea>
                </td>
                <td style="padding: 1%;">
                    <textarea id="div_debug"  style="width: 100%; resize: none;" rows="18" spellcheck="false"></textarea>
                </td>
                <td>
                    <input type="checkbox" id="auto_scroll" spellcheck="false"><label>Auto scroll</label>
                    <br>
                    <input type="number" id="update_time" max="30" min="0.2" step="0.1" value="1"> <label>Update Time</label>
                </td>
            </tbody> 
        </table>
        <table style="width: 100%;">
            <thead style="background-color: #ffae00; color: white;">
                <td style="padding: 1%;">Socket Programming</td>
                <td style="padding: 1%;">Recive Message</td>
                <td style="padding: 1%;">Send Message</td>
            </thead>
            <tbody> 
                <td style="padding: 1%;">
                    <textarea id="plc_socket_py" style="width: 100%;  resize: none;" rows="16" spellcheck="false"></textarea>
                </td>
                <td style="padding: 1%;">
                    <textarea id="plc_socket_msg" style="width: 100%;  resize: none;" rows="16" spellcheck="false"></textarea>
                </td>
                <td style="padding: 1%;">
                    <input type="text" id="text_send_message" placeholder="Send payload over sockets">
                    <button id="btn_send_message" class="btn btn-warning">Send message</button>
                </td>
            </tbody> 
         </table> 
        <table style="width: 100%;">  
            <thead style="background-color: #51c424; color: white;">
                <td style="padding: 1%;">Interupts</td>
                <td style="padding: 1%;">Inputs</td>
                <td style="padding: 1%;">Outputs</td>
            </thead>
            <tbody> 
                <td style="padding: 1%;">
                    <textarea id="plc_interrupt_py" style="width: 100%;  resize: none;" rows="16" spellcheck="false"></textarea>
                </td>
                <td style="padding: 1%;">
                    I0:<div id="I0">I0</div>
                    <br>
                    I1:<div id="I1">I1</div>
                    <br>
                    I2:<div id="I2">I2</div>
                    <br>
                    I3:<div id="I3">I3</div>
                    <br>
                    I4:<div id="I4">I4</div>
                    <br>
                    I5:<div id="I5">I5</div>
                    <br>
                </td style="padding: 1%;">
                <td style="padding: 1%;">
                    Q0:<div id="Q0">Q0</div>
                    <br>
                    Q1:<div id="Q1">Q1</div>
                    <br>
                    Q2:<div id="Q2">Q2</div>
                    <br>
                    Q3:<div id="Q3">Q3</div>
                    <br>
                    Q4:<div id="Q4">Q4</div>
                    <br>
                    Q5:<div id="Q5">Q5</div>
                    <br>
                </td>
            </tbody> 
         </table> 
    
    <script>

        var plc_py = document.getElementById("plc_py")
        var plc_interrupt_py = document.getElementById("plc_interrupt_py")
        var plc_socket_py = document.getElementById("plc_socket_py")
        var plc_socket_msg = document.getElementById("plc_socket_msg")
        var plc_py = document.getElementById("plc_py")
        var div_debug = document.getElementById("div_debug")
        var div_area = document.getElementById("div_area")
        var btn_save = document.getElementById("btn_save")
        var div_area = document.getElementById("div_area")
        var auto_scroll = document.getElementById("auto_scroll")
        var update_time = document.getElementById("update_time")
        var text_send_message = document.getElementById("text_send_message")
        var btn_send_message = document.getElementById("btn_send_message")

        var I0 = document.getElementById("I0")
        var I1 = document.getElementById("I1")
        var I2 = document.getElementById("I2")
        var I3 = document.getElementById("I3")
        var I4 = document.getElementById("I4")
        var I5 = document.getElementById("I5")

        var Q0 = document.getElementById("Q0")
        var Q1 = document.getElementById("Q1")
        var Q2 = document.getElementById("Q2")
        var Q3 = document.getElementById("Q3")
        var Q4 = document.getElementById("Q4")
        var Q5 = document.getElementById("Q5")

        var json = {
            plc_py:"",
            plc_interrupt_py:"",
            plc_socket_py:"",
            div_debug:"",
            save: "",
            update: "",
            debug: "",
            autoScroll: "0",
            updateTime: "1"
        }


        btn_save.addEventListener("click", function(){
            json.plc_py = plc_py.value
            json.plc_interrupt_py = plc_interrupt_py.value
            json.plc_socket_py = plc_socket_py.value
            json.updateTime = update_time.value
            json.save = "True"
            console.log(JSON.stringify(json))
            connection.send(JSON.stringify(json))
            json.save = "False"
            setTimeout(() => {
               location.reload(); 
            }, 8000);
        });

        btn_send_message.addEventListener("click", function(){
            connection.send(text_send_message.value)
            plc_socket_msg.innerHTML += "Sended\n"
        });

        auto_scroll.addEventListener("change", function(){
            if(auto_scroll.checked == true){
                json.autoScroll = "1"

            }
            if(auto_scroll.checked == false){
                json.autoScroll = "0"
            }
        });


        plc_py.addEventListener('keydown', function(e) {
            if (e.key == 'Tab') {
                e.preventDefault();
                var character = "    "
                var start = this.selectionStart
                var content = this.value
                var string0 = content.substring(0,this.selectionStart)
                var string1 = content.substring(this.selectionStart, content.length)
                var result = string0 + character + string1
                this.value = result
                this.selectionEnd = start + character.length;
            }
        });

        plc_interrupt_py.addEventListener('keydown', function(e) {
            if (e.key == 'Tab') {
                e.preventDefault();
                var character = "    "
                var start = this.selectionStart
                var content = this.value
                var string0 = content.substring(0,this.selectionStart)
                var string1 = content.substring(this.selectionStart, content.length)
                var result = string0 + character + string1
                this.value = result
                this.selectionEnd = start + character.length;
            }
        });

        plc_socket_py.addEventListener('keydown', function(e) {
            if (e.key == 'Tab') {
                e.preventDefault();
                var character = "    "
                var start = this.selectionStart
                var content = this.value
                var string0 = content.substring(0,this.selectionStart)
                var string1 = content.substring(this.selectionStart, content.length)
                var result = string0 + character + string1
                this.value = result
                this.selectionEnd = start + character.length;
            }
        });

        fetch('http://'+location.hostname+'/plc.py')
        .then(data => data.text())
        .then(function(data){
            console.log(data)
            json.plc_py = data
            plc_py.value = data
        });

        fetch('http://'+location.hostname+'/plcinterrupt.py')
        .then(data => data.text())
        .then(function(data){
            console.log(data)
            json.plc_interrupt_py = data
            plc_interrupt_py.value = data
        });

        fetch('http://'+location.hostname+'/plcsocket.py')
        .then(data => data.text())
        .then(function(data){
            console.log(data)
            json.plc_socket_py = data
            plc_socket_py.value = data
        });


        var interval;
        var interval1;

        interval1 = setInterval(function(){
            connection = new WebSocket('ws://'+location.hostname);
        },5000);

        fetch('http://'+location.hostname+'/plc.json')
        .then(data => data.json())
        .then(function(data){

            console.log(data)
            json.updateTime = data.updateTime
            update_time.value = data.updateTime

            if(data.autoScroll == "0"){
                auto_scroll.checked = false
                json.autoScroll = false
            }
            if(data.autoScroll == "1"){
                auto_scroll.checked = true
                json.autoScroll = true
            }

            interval = setInterval(function(){
                json.debug = "True"
                console.log("Sending message to server")
                connection.send(JSON.stringify(json))
                json.debug = "False"
            }, ((Number(data.updateTime)*1000)));

        });


        var connection;

        connection = new WebSocket('ws://'+location.hostname);

        connection.onopen = function () {
            console.log(`Open conection websocket with ${location.hostname}`);
            clearInterval(interval1);
        };

            // Log errors
        connection.onerror = function (error) {
            console.log('WebSocket Error ' + error);
        };

        var lastMessage = "";

            // Log messages from the server
        connection.onmessage = function (e) {

            var data = JSON.parse(e.data);
            console.log(data)
            console.log("Arrived data from server")
            if(data.data != null && data.data != undefined && data.data != "" && data.data != "None"){
                plc_socket_msg.innerHTML += data.data + "\n"
                plc_socket_msg.scrollTop = plc_socket_msg.scrollHeight;
            }
            if(data.debug == "True"){
                if(lastMessage!=data.div_debug){
                    lastMessage = data.div_debug
                    div_debug.innerHTML += data.div_debug + "\n"
                    if(json.autoScroll == "1"){
                        div_debug.scrollTop = div_debug.scrollHeight;
                    }  
                }
                
            }
            try{
                if(data.I0 != undefined){I0.innerHTML = data.I0}
                if(data.I1 != undefined){I1.innerHTML = data.I1}
                if(data.I2 != undefined){I2.innerHTML = data.I2}
                if(data.I3 != undefined){I3.innerHTML = data.I3}
                if(data.I4 != undefined){I4.innerHTML = data.I4}
                if(data.I5 != undefined){I5.innerHTML = data.I5}

                if(data.Q0 != undefined){Q0.innerHTML = data.Q0}
                if(data.Q1 != undefined){Q1.innerHTML = data.Q1}
                if(data.Q2 != undefined){Q2.innerHTML = data.Q2}
                if(data.Q3 != undefined){Q3.innerHTML = data.Q3}
                if(data.Q4 != undefined){Q4.innerHTML = data.Q4}
                if(data.Q5 != undefined){Q5.innerHTML = data.Q5}
            }
            catch{
                console.log("error receiving I/O's information")
            }
            
        }
            
        connection.onclose = function(){
            console.log("socket disconected")
        }

    </script>
</body>
</html>